<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="resultPage.css" />
    <title>Dino Destinations</title>
</head>
<body>
    <div class="logo"><img src="./images/dd_logo.png" alt="Dino Destinations Logo"></div>
    <div class="container">
        <div id="loading-overlay">
            <div id="loading-spinner">
                <div class="lds-ring">
                    <div></div><div></div><div></div><div></div>
                </div>
                <p>Loading...</p>
            </div>
        </div>
        <div id="infoBox">
            <div id="infoBoxInner">
                <!-- Place details will be dynamically inserted here -->
            </div>
        </div>
        <div id="map"></div>
    </div>
    <script>
        function initMap() {
            const urlParams = new URLSearchParams(window.location.search);
            const city = urlParams.get('city');

            if (!city) {
                showError('No city specified');
                return;
            }

            // Show the loading overlay
            document.getElementById('loading-overlay').style.display = 'flex';

            // Geocode the city first to get more accurate location
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: city }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;
                    const map = new google.maps.Map(document.getElementById('map'), {
                        zoom: 12,
                        center: location,
                    });

                    const service = new google.maps.places.PlacesService(map);
                    const request = {
                        query: `${city} dinosaur `,
                        type: ['museum'],
                        fields: ["name", "geometry", "formatted_address", "rating", "user_ratings_total"],
                    };

                    service.textSearch(request, (results, status) => {
                        // Hide the loading overlay
                        document.getElementById('loading-overlay').style.display = 'none';

                        if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
                            // Clear any previous "no results" message
                            document.getElementById('infoBoxInner').innerHTML = '';
                            
                            // Sort results by distance from the city
                            const cityLocation = new google.maps.LatLng(location.lat(), location.lng());
                            results.sort((a, b) => {
                                const aLocation = new google.maps.LatLng(a.geometry.location.lat(), a.geometry.location.lng());
                                const bLocation = new google.maps.LatLng(b.geometry.location.lat(), b.geometry.location.lng());
                                const aDistance = google.maps.geometry.spherical.computeDistanceBetween(cityLocation, aLocation) / 1609.34; // Distance in miles
                                const bDistance = google.maps.geometry.spherical.computeDistanceBetween(cityLocation, bLocation) / 1609.34; // Distance in miles
                                return aDistance - bDistance;
                            });

                            // Filter results to only include those within a 25-mile radius of the city
                            const filteredResults = results.filter(place => {
                                const placeLocation = new google.maps.LatLng(place.geometry.location.lat(), place.geometry.location.lng());
                                const distance = google.maps.geometry.spherical.computeDistanceBetween(cityLocation, placeLocation) / 1609.34; // Distance in miles
                                return distance <= 25;
                            });

                            if (filteredResults.length > 0) {
                                filteredResults.forEach((place) => {
                                    new google.maps.Marker({
                                        map: map,
                                        position: place.geometry.location,
                                        title: place.name
                                    });
                                    addPlaceDetails(place);
                                });

                                // Center map on first result
                                map.setCenter(filteredResults[0].geometry.location);
                            } else {
                                showError('No dinosaur museums found within 25 miles of this city.');
                            }
                        } else {
                            showError('No dinosaur museums found in this city.');
                        }
                    });
                } else {
                    showError('Could not locate the specified city.');
                }
            });
        }

        function addPlaceDetails(place) {
            const infoBoxInner = document.getElementById('infoBoxInner');
            const placeDetails = `
                <div class="place-details">
                    <strong>${place.name}</strong>
                    <p>${place.formatted_address}</p>
                    ${place.rating ? `<p>Rating: ${place.rating}/5 (${place.user_ratings_total || 0} reviews)</p>` : ''}
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(place.formatted_address)}" target="_blank">Get Directions</a>
                </div>
            `;
            infoBoxInner.innerHTML += placeDetails;
        }

        function showError(message) {
            const infoBoxInner = document.getElementById('infoBoxInner');
            infoBoxInner.innerHTML = `<p class="error">${message}</p>`;
        }

        // Error handling for script loading
        window.onerror = function(message, source, lineno, colno, error) {
            showError('An error occurred while loading the map. Please try again later.');
            return true;
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBZMo8PlLxIf1QUUlPTIMzeNu2giPGHRwI&libraries=places,geometry&callback=initMap" defer onerror="showError('Failed to load Google Maps')"></script>
</body>
</html>